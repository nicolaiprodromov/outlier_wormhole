# Logrotate configuration for Outlier Wormhole data directory
# Manages log files and conversation data rotation

# Rotate log files in data directory
/app/data/**/*.log /var/log/janitor/*.log {
    # Rotate logs daily
    daily

    # Keep 7 days of rotated logs
    rotate 7

    # Compress rotated logs using gzip
    compress

    # Delay compression until next rotation cycle
    # (prevents issues with actively written files)
    delaycompress

    # Don't error if log file is missing
    missingok

    # Don't rotate empty log files
    notifempty

    # Create new log file with these permissions after rotation
    create 0640 janitor janitor

    # Use date as suffix for rotated files (YYYYMMDD format)
    dateext
    dateformat -%Y%m%d

    # If log file size exceeds 10M, rotate immediately regardless of time
    maxsize 10M

    # Post-rotation script
    postrotate
        # Log rotation event
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Logrotate completed" >> /var/log/janitor/rotation.log 2>&1 || true
    endscript

    # Share compression lock to avoid issues with parallel rotations
    sharedscripts
}

# Rotate markdown dump files (more aggressive)
/app/data/raw_dumps/*.md {
    # Rotate weekly
    weekly

    # Keep only 4 weeks
    rotate 4

    # Compress immediately
    compress

    # Don't error if files are missing
    missingok

    # Don't rotate empty files
    notifempty

    # If size exceeds 5M, rotate immediately
    maxsize 5M

    # Use date suffix
    dateext
    dateformat -%Y%m%d

    # Copy and truncate instead of moving
    # (safer for actively written files)
    copytruncate
}

# Rotate janitor's own logs
/var/log/janitor/cleanup.log {
    # Rotate weekly
    weekly

    # Keep 4 weeks
    rotate 4

    # Compress
    compress
    delaycompress

    # Don't error if missing
    missingok

    # Don't rotate empty
    notifempty

    # Create new file
    create 0640 janitor janitor

    # Max size 50M
    maxsize 50M

    # Date extension
    dateext
}
